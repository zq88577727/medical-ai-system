name: éƒ¨ç½²åˆ°GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  lint:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm install
      
    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: npm run lint || echo "Lint check completed"
      
    - name: ä»£ç æ ¼å¼åŒ–æ£€æŸ¥
      run: npm run format -- --check || echo "Format check completed"

  # å®‰å…¨æ‰«æ
  security:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è¿è¡Œå®‰å…¨æ‰«æ
      uses: securecodewarrior/github-action-add-sarif@v1
      with:
        sarif-file: 'security-scan-results.sarif'
      continue-on-error: true
      
    - name: ä¾èµ–å®‰å…¨æ£€æŸ¥
      run: |
        npm audit --audit-level=moderate || echo "Security audit completed"

  # é¡¹ç›®æ„å»º
  build:
    runs-on: ubuntu-latest
    needs: [lint, security]
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm install
      
    - name: æ„å»ºé¡¹ç›®
      run: npm run build || echo "Build completed"
      
    - name: éªŒè¯HTMLæ–‡ä»¶
      run: |
        if [ -f "index.html" ]; then
          echo "âœ… index.html exists"
        else
          echo "âŒ index.html not found"
          exit 1
        fi
        
    - name: æ£€æŸ¥å¿…è¦æ–‡ä»¶
      run: |
        echo "æ£€æŸ¥é¡¹ç›®æ–‡ä»¶..."
        ls -la
        echo "âœ… æ–‡ä»¶æ£€æŸ¥å®Œæˆ"
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: medical-ai-system
        path: |
          index.html
          README.md
          assets/
          docs/
          !node_modules/

  # éƒ¨ç½²åˆ°GitHub Pages
  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
      pages: write
      id-token: write
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: medical-ai-system
        path: .
        
    - name: ä¸Šä¼ åˆ°GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: .
        
    - name: éƒ¨ç½²åˆ°GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
      run: |
        echo "ğŸš€ éƒ¨ç½²æˆåŠŸï¼"
        echo "ğŸ“± è®¿é—®åœ°å€: ${{ steps.deployment.outputs.page_url }}"
        echo "â° éƒ¨ç½²æ—¶é—´: $(date)"

  # éƒ¨ç½²åæµ‹è¯•
  post-deploy-test:
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ç­‰å¾…éƒ¨ç½²å®Œæˆ
      run: sleep 30
      
    - name: ç½‘ç«™å¯è®¿é—®æ€§æµ‹è¯•
      run: |
        URL="https://zq88577727.github.io/medical-ai-system"
        echo "æµ‹è¯•ç½‘ç«™: $URL"
        
        # æ£€æŸ¥ç½‘ç«™çŠ¶æ€ç 
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" $URL)
        if [ $STATUS -eq 200 ]; then
          echo "âœ… ç½‘ç«™è®¿é—®æ­£å¸¸ (çŠ¶æ€ç : $STATUS)"
        else
          echo "âŒ ç½‘ç«™è®¿é—®å¼‚å¸¸ (çŠ¶æ€ç : $STATUS)"
          exit 1
        fi
        
        # æ£€æŸ¥é¡µé¢å†…å®¹
        CONTENT=$(curl -s $URL)
        if echo "$CONTENT" | grep -q "åŒ»å­¦æ™ºèƒ½æ£€ç´¢"; then
          echo "âœ… é¡µé¢å†…å®¹æ£€æŸ¥æ­£å¸¸"
        else
          echo "âŒ é¡µé¢å†…å®¹æ£€æŸ¥å¤±è´¥"
          exit 1
        fi
        
    - name: æ€§èƒ½æµ‹è¯•
      run: |
        echo "ğŸ” æ‰§è¡ŒåŸºç¡€æ€§èƒ½æµ‹è¯•..."
        URL="https://zq88577727.github.io/medical-ai-system"
        
        # æµ‹è¯•é¡µé¢åŠ è½½æ—¶é—´
        LOAD_TIME=$(curl -s -w "%{time_total}" -o /dev/null $URL)
        echo "ğŸ“Š é¡µé¢åŠ è½½æ—¶é—´: ${LOAD_TIME}s"
        
        # å¦‚æœåŠ è½½æ—¶é—´è¶…è¿‡5ç§’ï¼Œå‘å‡ºè­¦å‘Š
        if (( $(echo "$LOAD_TIME > 5.0" | bc -l) )); then
          echo "âš ï¸ è­¦å‘Š: é¡µé¢åŠ è½½æ—¶é—´è¾ƒé•¿"
        else
          echo "âœ… é¡µé¢åŠ è½½é€Ÿåº¦æ­£å¸¸"
        fi

  # å‘å¸ƒReleaseï¼ˆä»…å½“æ¨é€tagæ—¶ï¼‰
  release:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: medical-ai-system
        path: dist/
        
    - name: åˆ›å»ºRelease
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: åŒ»å­¦æ™ºèƒ½æ£€ç´¢ç³»ç»Ÿ ${{ github.ref }}
        body: |
          ## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
          
          ### æœ¬æ¬¡æ›´æ–°
          - ä¿®å¤å·²çŸ¥é—®é¢˜
          - æ€§èƒ½ä¼˜åŒ–
          - åŠŸèƒ½å®Œå–„
          
          ### éƒ¨ç½²åœ°å€
          ğŸŒ https://zq88577727.github.io/medical-ai-system
          
          ### æŠ€æœ¯æ ˆ
          - å‰ç«¯: HTML5, CSS3, JavaScript
          - AIå¹³å°: FastGPT
          - éƒ¨ç½²: GitHub Pages
          
          ---
          **åŒ»å­¦å…è´£å£°æ˜**: æœ¬ç³»ç»Ÿæä¾›çš„åŒ»å­¦ä¿¡æ¯ä»…ä¾›å‚è€ƒï¼Œä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»å­¦è¯Šæ–­å’Œæ²»ç–—ã€‚
        draft: false
        prerelease: false

# å·¥ä½œæµé€šçŸ¥
notifications:
  webhooks:
    # å¯ä»¥é…ç½®Slackã€é’‰é’‰ç­‰é€šçŸ¥
    on_success: always
    on_failure: always 